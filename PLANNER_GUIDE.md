# COLT Task Planner Guide

## Overview

The COLT Task Planner is an LLM-powered component that converts natural language prompts into executable action plans for web automation. It uses the exploration data generated by COLT's web explorer to understand how your application works and creates step-by-step plans to accomplish user-requested tasks.

## Architecture

```
┌─────────────────────────────────────────────────────┐
│                  User Prompt                         │
│           "Submit the contact form"                  │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│              Context Builder                         │
│  • Loads exploration data (agent_data.json, etc.)   │
│  • Finds relevant actions, pages, flows              │
│  • Builds optimized context for LLM                  │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│                LLM Client                            │
│  • Sends context + prompt to LLM API                │
│  • Supports OpenAI, Anthropic, local models          │
│  • Receives structured action plan                  │
└──────────────────┬──────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────┐
│              Action Plan                             │
│  • Step-by-step instructions                        │
│  • Selectors, URLs, form data                       │
│  • Expected outcomes, verification steps             │
│  • Confidence score                                  │
└─────────────────────────────────────────────────────┘
```

## Components

### 1. ContextBuilder (`src/planner/context_builder.py`)
- Loads exploration data from the output directory
- Finds actions, pages, and flows relevant to user prompts
- Uses keyword matching to score relevance (can be enhanced with embeddings)
- Formats context in a way LLMs can understand

### 2. LLMClient (`src/planner/llm_client.py`)
- Handles communication with LLM APIs
- Supports multiple providers:
  - **OpenAI** (GPT-4, GPT-3.5)
  - **Anthropic** (Claude 3.5 Sonnet, Opus, Haiku)
  - **Local** (Ollama, LM Studio, etc.)
- Generates structured JSON plans
- Validates plans against available actions

### 3. TaskPlanner (`src/planner/task_planner.py`)
- Main orchestrator
- Coordinates context building and LLM generation
- Validates and saves generated plans
- Provides interactive CLI mode

## Installation

1. **Install dependencies:**
```bash
pip install -r requirements.txt
```

2. **Install Playwright browsers** (if not already done):
```bash
playwright install chromium
```

3. **Set up API keys:**

For OpenAI:
```bash
export OPENAI_API_KEY="sk-..."
```

For Anthropic:
```bash
export ANTHROPIC_API_KEY="sk-ant-..."
```

Or create a `.env` file:
```
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
```

## Usage

### Step 1: Run the Explorer

First, explore your web application to generate the knowledge base:

```bash
# Make sure your app is running on localhost:3000 (or update BASE_URL in config.py)
python explorer.py
```

This generates exploration data in the `output/` directory:
- `agent_data.json` - Complete application knowledge
- `action_library.json` - All available actions
- `api_map.json` - API endpoint mapping
- `state_machine.json` - State transitions
- `user_flows.json` - Common user flows
- And more...

### Step 2: Use the Task Planner

#### Interactive Mode (Recommended)

```bash
python planner_cli.py
```

This starts an interactive session where you can:
- Enter natural language task descriptions
- View generated plans
- Approve/reject plans
- See app summaries

Example session:
```
> Submit the contact form with test data

Planning task: Submit the contact form with test data
===============================================================

1. Building context from exploration data...
   - Found 5 relevant actions
   - Found 2 relevant pages
   - Found 1 relevant flows
   - Found 2 relevant API endpoints

2. Generating action plan with LLM...
   ✓ Generated plan with 4 steps

3. Validating plan...
   ✓ Plan is valid

============================================================
ACTION PLAN
============================================================

Task: Submit contact form with test data

Steps:

1. [NAVIGATE] Navigate to contact page
   URL: http://localhost:3000/contact
   Expected: Contact form is displayed
   Verify: Form with id 'contact-form' is visible

2. [FILL_FORM] Fill out the contact form
   Selector: #contact-form
   Form data: {
     "name": "Test User",
     "email": "test@example.com",
     "message": "This is a test message"
   }
   Expected: All fields are filled
   Verify: All input fields have values

3. [CLICK] Submit the form
   Selector: button[type="submit"]
   Element: 'Submit'
   Expected: Form is submitted
   Verify: Success message appears or URL changes

4. [VERIFY] Verify submission
   Expected: Confirmation message or redirect
   Verify: Check for success indicator

Expected Result: Contact form submitted successfully with test data

Confidence: 85.0%
============================================================

Approve this plan? (yes/no):
```

#### Single Task Mode

Generate a plan for one task:

```bash
python planner_cli.py "Create a new user account"
```

#### Show App Summary

```bash
python planner_cli.py --summary
```

#### Use Different LLM Provider

```bash
# Use Anthropic Claude
python planner_cli.py --provider anthropic "Login to the application"

# Use local model (Ollama)
python planner_cli.py --provider local --model llama2 "Search for products"
```

## Configuration

Edit `config.py` to customize the planner:

```python
# LLM Provider
LLM_PROVIDER = "openai"  # "openai", "anthropic", or "local"
LLM_MODEL = None  # Use provider default, or specify model
LLM_TEMPERATURE = 0.7  # 0.0 = deterministic, 1.0 = creative
LLM_MAX_TOKENS = 2000

# Context limits
PLANNER_MAX_RELEVANT_ACTIONS = 10
PLANNER_MAX_RELEVANT_PAGES = 5
PLANNER_MAX_RELEVANT_FLOWS = 3
```

## Generated Plan Structure

Plans are JSON objects with this structure:

```json
{
  "task_description": "Brief description",
  "steps": [
    {
      "step_number": 1,
      "action_type": "navigate|click|fill_form|wait|verify",
      "description": "What this step does",
      "target": {
        "selector": "CSS selector",
        "url": "URL if navigating",
        "text": "Element text",
        "form_data": {"field": "value"}
      },
      "expected_outcome": "What should happen",
      "verification": "How to verify success"
    }
  ],
  "prerequisites": ["Required conditions"],
  "expected_result": "Final outcome",
  "potential_errors": ["Things that might go wrong"],
  "confidence": 0.85
}
```

## Example Prompts

Here are some example prompts you can try:

### Forms
- "Submit the contact form with test data"
- "Fill out the registration form and create an account"
- "Search for 'laptop' using the search form"

### Navigation
- "Navigate to the about page"
- "Go to the product details page"
- "Open the user settings"

### Complex Tasks
- "Create a new user account with email john@example.com"
- "Add a product to the cart and proceed to checkout"
- "Login, update profile information, and logout"
- "Submit a support ticket about a billing issue"

### CRUD Operations
- "Create a new blog post"
- "Delete the test user account"
- "Update the product price to $29.99"
- "View all orders from last month"

## Programmatic Usage

You can also use the planner programmatically in your Python code:

```python
from src.planner.task_planner import TaskPlanner

# Initialize planner
planner = TaskPlanner(
    output_dir="output",
    llm_provider="openai",
    temperature=0.7
)

# Load exploration data
planner.load_exploration_data()

# Generate plan
result = planner.plan_task("Submit the contact form")

# Access the plan
plan = result["plan"]
print(f"Steps: {len(plan['steps'])}")
print(f"Confidence: {plan['confidence']}")

# Get human-readable explanation
explanation = planner.explain_plan(plan)
print(explanation)
```

## Next Steps: Execution

The Task Planner currently generates plans but does not execute them. The next phase is to build the **Task Executor** which will:

1. Take a generated plan
2. Use Playwright to execute each step
3. Verify expected outcomes
4. Handle errors and retries
5. Report progress and results

Coming soon: `executor.py` and `execute_plan.py` CLI tool!

## Troubleshooting

### "Exploration data not loaded"
- Make sure you've run `python explorer.py` first
- Check that `output/agent_data.json` exists
- Verify the `--output-dir` path is correct

### "API key not found"
- Set the appropriate environment variable:
  - `OPENAI_API_KEY` for OpenAI
  - `ANTHROPIC_API_KEY` for Anthropic
- Or pass `--api-key` to the CLI

### "Low confidence plan"
- The app may not have been fully explored
- Try running the explorer with higher limits (MAX_PAGES, MAX_DEPTH)
- The prompt may be too vague - be more specific

### "Could not parse JSON from LLM"
- Some models struggle with JSON output
- Try using a more capable model (GPT-4, Claude Sonnet)
- Increase `LLM_MAX_TOKENS` if response is cut off

## Advanced Features (Coming Soon)

- **Embeddings-based retrieval** - Use vector search instead of keyword matching
- **Few-shot examples** - Improve plan quality with example plans
- **Multi-step verification** - Test plans before execution
- **Plan optimization** - Merge redundant steps, optimize for speed
- **Error recovery** - Generate alternative plans when steps fail
- **Learning from feedback** - Improve plans based on execution results

## Contributing

The planner is modular and extensible. To add features:

1. **New LLM provider** - Extend `LLMClient._initialize_client()`
2. **Better relevance** - Enhance `ContextBuilder._find_relevant_actions()`
3. **Plan validation** - Add checks in `LLMClient.validate_plan()`
4. **New action types** - Update system prompt in `LLMClient.generate_structured_plan()`

## License

MIT License - Same as the main COLT project
